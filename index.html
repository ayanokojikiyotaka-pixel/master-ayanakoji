<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üìö IELTS VOCAB TRAINOR ¬∑ ULTIMATE EDITION üìö</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Anime.js for effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1"></script>
    <!-- Moment.js for time -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ========== 20 AMAZING THEMES ========== */
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0a0c10;
            --surface: #14181f;
            --surface-light: #1e293b;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --border: #2d3748;
            --header-bg: #0f131a;
        }

        /* Anime Themes */
        [data-theme="rezero"] { --primary: #9b59b6; --bg: #1a0933; --surface: #2d1b4a; }
        [data-theme="mushoku"] { --primary: #ff6b6b; --bg: #1a2f3f; --surface: #2a4055; }
        [data-theme="sololeveling"] { --primary: #aa80ff; --bg: #0d071a; --surface: #1a1033; }
        [data-theme="demonslayer"] { --primary: #ff4444; --bg: #2c1810; --surface: #3d291f; }
        [data-theme="onepiece"] { --primary: #ffd700; --bg: #0a1a2a; --surface: #1a2a3d; }
        [data-theme="naruto"] { --primary: #ff8c42; --bg: #1a0f0a; --surface: #2d1f17; }
        [data-theme="dbz"] { --primary: #ffaa00; --bg: #1a0f1a; --surface: #2d1f2d; }
        [data-theme="aot"] { --primary: #8b4513; --bg: #1a1a1a; --surface: #2d2d2d; }
        [data-theme="jjk"] { --primary: #9933ff; --bg: #0d0022; --surface: #1a1038; }
        [data-theme="tokyoghoul"] { --primary: #dc143c; --bg: #1a0f0f; --surface: #2d1f1f; }
        [data-theme="deathnote"] { --primary: #4a4a4a; --bg: #0a0a0a; --surface: #1a1a1a; }
        [data-theme="chainsaw"] { --primary: #ff3333; --bg: #2b0f0f; --surface: #3f1f1f; }
        [data-theme="seoul"] { --primary: #ff5e7d; --bg: #1a1e2b; --surface: #252b3d; }
        [data-theme="busan"] { --primary: #00d2ff; --bg: #0f2027; --surface: #203a43; }
        [data-theme="jeju"] { --primary: #32cd32; --bg: #1a2f1a; --surface: #2d4a2d; }
        [data-theme="tokyo"] { --primary: #ff3366; --bg: #1a1a2e; --surface: #16213e; }
        [data-theme="kyoto"] { --primary: #ff8c42; --bg: #2c1810; --surface: #3e2a1f; }
        [data-theme="ielts"] { --primary: #2c3e50; --bg: #1a2634; --surface: #2c3e50; }
        [data-theme="academic"] { --primary: #8e44ad; --bg: #1a1f2e; --surface: #2c3a5e; }
        [data-theme="writing"] { --primary: #27ae60; --bg: #1a2f1a; --surface: #2d4a2d; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.5;
            font-size: 14px;
            padding: 12px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===== AUTH SECTION ===== */
        .auth-section {
            max-width: 500px;
            margin: 50px auto;
            background: var(--surface);
            border-radius: 30px;
            padding: 40px;
            border: 2px solid var(--primary);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: glowPulse 3s infinite;
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 0 20px var(--primary); }
            50% { box-shadow: 0 0 40px var(--primary); }
            100% { box-shadow: 0 0 20px var(--primary); }
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: var(--bg);
            padding: 5px;
            border-radius: 50px;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .auth-form {
            display: block;
        }

        .auth-form.hidden {
            display: none;
        }

        /* Password strength meter */
        .password-strength {
            margin-top: 5px;
            height: 5px;
            border-radius: 5px;
            background: var(--border);
            overflow: hidden;
        }
        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background 0.3s;
        }
        .strength-text {
            font-size: 11px;
            margin-top: 2px;
            color: var(--text-dim);
        }
        .strength-weak { background: #ef4444; }
        .strength-medium { background: #f59e0b; }
        .strength-strong { background: #22c55e; }

        /* ===== HEADER ===== */
        .header {
            background: var(--surface);
            padding: 20px 25px;
            border-radius: 30px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
        }

        .rank-badge {
            padding: 5px 15px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 12px;
        }
        .rank-bronze { background: #cd7f32; color: #000; }
        .rank-silver { background: #c0c0c0; color: #000; }
        .rank-gold { background: #ffd700; color: #000; }
        .rank-platinum { background: #e5e4e2; color: #000; }
        .rank-diamond { background: #b9f2ff; color: #000; }
        .rank-master { background: #b266ff; color: #fff; }
        .rank-grandmaster { background: #ff4d4d; color: #fff; }
        .rank-conqueror { background: #ff0000; color: #fff; }
        .rank-ielts { background: #2c3e50; color: #fff; }

        /* ===== THEME SELECTOR ===== */
        .theme-section {
            background: var(--surface);
            padding: 20px;
            border-radius: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .theme-title {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--text);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }

        .theme-btn {
            padding: 10px 5px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .theme-btn:hover, .theme-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Theme preview cards */
        .theme-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .theme-preview-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
            text-align: center;
        }
        .theme-preview-card:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }
        .theme-preview-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary);
        }
        .color-swatch {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 8px;
        }
        .swatch {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--border);
        }
        .theme-name {
            font-size: 12px;
            font-weight: 600;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--surface);
            padding: 15px 5px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .stat-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .stat-trend {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 10px;
            background: var(--bg);
        }
        .trend-up { color: #22c55e; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #94a3b8; }

        /* ===== MENU GRID ===== */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .menu-card {
            position: relative;
            background: var(--surface);
            padding: 20px 10px;
            border-radius: 24px;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .menu-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), transparent);
        }

        .menu-card i {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .menu-card h3 {
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .menu-card p {
            font-size: 10px;
            color: var(--text-dim);
            position: relative;
            z-index: 1;
        }

        /* Progress ring inside card */
        .menu-progress {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
        }

        .menu-progress svg {
            width: 40px;
            height: 40px;
            transform: rotate(-90deg);
        }

        .menu-progress circle {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
        }

        .menu-progress .bg-circle {
            stroke: var(--border);
        }

        .menu-progress .progress-circle {
            stroke: var(--primary);
            stroke-dasharray: 100;
            stroke-dashoffset: calc(100 - var(--progress));
            transition: stroke-dashoffset 0.5s;
        }

        .menu-progress span {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Quick action bar */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 5px 0;
            -webkit-overflow-scrolling: touch;
        }

        .quick-action-btn {
            flex: 0 0 auto;
            padding: 12px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 40px;
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Recent activity */
        .recent-activity {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* ===== PAGES ===== */
        .page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        .page.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .page-header h2 {
            font-size: 28px;
            color: var(--primary);
        }

        .close-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px 20px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
        }

        .btn {
            padding: 15px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(59,130,246,0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--surface);
            border-color: var(--primary);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        /* ===== WORD CARD ===== */
        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .word-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
        }

        .word-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .word-card .word {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .word-card .meaning {
            font-size: 16px;
            margin: 10px 0;
            color: var(--text-dim);
        }

        .mastery-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .mastery-weak { background: #ef4444; color: white; }
        .mastery-learning { background: #f59e0b; color: white; }
        .mastery-mastered { background: #22c55e; color: white; }

        .word-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .word-actions button {
            flex: 1;
            padding: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .word-actions button:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* ===== VOICE SYSTEM ===== */
        .voice-system {
            background: var(--surface);
            border-radius: 30px;
            padding: 20px;
            margin: 20px 0;
        }

        .big-button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .big-voice-btn {
            aspect-ratio: 1;
            border-radius: 50%;
            background: var(--bg);
            border: 2px solid var(--border);
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .big-voice-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .accent-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .accent-btn {
            padding: 8px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 30px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .accent-btn:hover,
        .accent-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pronunciation-meter {
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .pronunciation-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #22c55e);
            transition: width 0.3s;
        }

        /* ===== PRACTICE PAGE ===== */
        .practice-container {
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        .practice-word {
            font-size: 72px;
            font-weight: 800;
            color: var(--primary);
            margin: 30px 0;
            text-shadow: 0 0 30px rgba(59,130,246,0.5);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0% { text-shadow: 0 0 20px var(--primary); }
            50% { text-shadow: 0 0 40px var(--primary); }
            100% { text-shadow: 0 0 20px var(--primary); }
        }

        .voice-controls-panel {
            background: var(--surface-light);
            border-radius: 60px;
            padding: 20px 30px;
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary);
        }

        .voice-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--border);
            color: var(--text);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.1) rotate(5deg);
        }

        .voice-speed-slider {
            width: 150px;
        }

        .progress-bar {
            height: 15px;
            background: var(--border);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        /* ===== GAMES STYLES ===== */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .game-card {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .game-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .game-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .game-area {
            background: var(--surface);
            border-radius: 30px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
        }

        .game-word {
            font-size: 48px;
            font-weight: 800;
            color: var(--primary);
            margin: 20px 0;
        }

        .game-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .game-option {
            padding: 15px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-option:hover {
            background: var(--surface-light);
            border-color: var(--primary);
        }

        .game-option.correct {
            background: var(--success);
            color: white;
        }

        .game-option.wrong {
            background: var(--danger);
            color: white;
        }

        .game-timer {
            width: 100%;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: var(--primary);
            width: 100%;
            transition: width 1s linear;
        }

        /* ===== CHAT SYSTEM STYLES ===== */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            gap: 8px;
        }

        .groups-scroll {
            background: var(--surface);
            border-radius: 20px;
            padding: 12px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .group-chip {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 8px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 30px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .group-chip:hover,
        .group-chip.active {
            background: var(--primary);
            color: white;
        }

        .chat-area {
            flex: 1;
            background: var(--surface);
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-row {
            display: flex;
            margin-bottom: 10px;
        }

        .message-row.own {
            justify-content: flex-end;
        }

        .message-row.other {
            justify-content: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .message-container {
            max-width: 70%;
        }

        .message-sender {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .admin-badge {
            font-size: 12px;
            color: gold;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            word-break: break-word;
            position: relative;
        }

        .message-bubble.own {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-bubble.other {
            background: var(--bg);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 9px;
            margin-top: 3px;
            opacity: 0.6;
            text-align: right;
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 30px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 14px;
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== STORE STYLES ===== */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .store-item {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            border: 2px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .store-item:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .store-item.popular::before {
            content: 'üî• POPULAR';
            position: absolute;
            top: 15px;
            right: -30px;
            background: var(--primary);
            color: white;
            padding: 5px 30px;
            transform: rotate(45deg);
            font-size: 11px;
        }

        .item-icon {
            font-size: 48px;
            margin-bottom: 15px;
            text-align: center;
        }

        .item-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 28px;
            font-weight: 800;
            color: gold;
            margin-bottom: 15px;
        }

        .buy-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== STATISTICS DASHBOARD ===== */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .chart-container {
            background: var(--surface);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 2px;
            min-width: 800px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 3px;
        }

        .heatmap-cell[data-level="0"] { background: var(--border); }
        .heatmap-cell[data-level="1"] { background: #9be9a8; }
        .heatmap-cell[data-level="2"] { background: #40c463; }
        .heatmap-cell[data-level="3"] { background: #30a14e; }
        .heatmap-cell[data-level="4"] { background: #216e39; }

        .weak-words-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* ===== MODAL ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 30px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            border: 2px solid var(--primary);
        }

        /* ===== NOTIFICATIONS ===== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--surface);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            color: var(--text);
            z-index: 3000;
            animation: slideIn 0.3s;
        }
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: var(--danger); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(4, 1fr); }
            .menu-grid { grid-template-columns: repeat(3, 1fr); }
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
            .games-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- MASTER ACCOUNT DATA -->
    <div style="display: none;" id="master-data" 
         data-email="ayanakoji4@gmail.com" 
         data-name="Ayanakoji Kiyotaka" 
         data-username="Monster">
    </div>

    <div class="container">
        <!-- AUTH SECTION -->
        <div id="authSection" class="auth-section">
            <h1 style="text-align: center; margin-bottom: 20px; color: var(--primary);">üìö IELTS VOCAB TRAINOR</h1>
            <p style="text-align: center; margin-bottom: 30px; color: var(--text-dim);">Master IELTS vocabulary with games, chat & analytics!</p>
            
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">LOGIN</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">REGISTER</div>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username or Email</label>
                    <input type="text" id="loginUsername" placeholder="Enter username or email">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <input type="checkbox" id="rememberMe" style="width: auto; margin-right: 10px;">
                    <label for="rememberMe" style="margin-bottom: 0;">Remember me</label>
                </div>
                <button class="btn" onclick="loginUser()" style="width: 100%;">üîì LOGIN</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-dim);">
                    <a href="#" onclick="showForgotPassword()" style="color: var(--primary);">Forgot password?</a>
                </p>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <div class="form-group">
                    <label><i class="fas fa-user-circle"></i> Username *</label>
                    <input type="text" id="regUsername" placeholder="e.g., ielts_master" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-signature"></i> Full Name *</label>
                    <input type="text" id="regName" placeholder="Your full name" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email *</label>
                    <input type="email" id="regEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password *</label>
                    <input type="password" id="regPassword" placeholder="At least 8 chars" required oninput="checkPasswordStrength()">
                    <div class="password-strength">
                        <div class="strength-bar" id="strengthBar"></div>
                    </div>
                    <div class="strength-text" id="strengthText">Enter password</div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Confirm Password *</label>
                    <input type="password" id="regConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button class="btn" onclick="registerUser()" style="width: 100%;">üìù REGISTER</button>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="mainApp" class="hidden">
            <!-- HEADER -->
            <div class="header">
                <div class="logo">üìö IELTS VOCAB TRAINOR</div>
                <div class="user-section">
                    <div class="user-avatar" id="userAvatar">üë§</div>
                    <div class="user-name" id="userName">IELTS Learner</div>
                    <div class="rank-badge rank-ielts" id="rankDisplay">IELTS</div>
                    <div class="coins">
                        <i class="fas fa-coins" style="color: gold;"></i> 
                        <span id="coinDisplay">0</span>
                    </div>
                    <button class="theme-btn" onclick="logout()" style="width: auto; padding: 8px 16px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- QUICK ACTIONS -->
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="openPage('practicePage')">
                    <i class="fas fa-brain"></i> Quick Practice
                </button>
                <button class="quick-action-btn" onclick="openPage('addPage')">
                    <i class="fas fa-plus"></i> Add Word
                </button>
                <button class="quick-action-btn" onclick="openPage('gamesPage')">
                    <i class="fas fa-gamepad"></i> Play Games
                </button>
                <button class="quick-action-btn" onclick="openPage('chatPage')">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>

            <!-- THEME SELECTOR -->
            <div class="theme-section">
                <div class="theme-title">
                    <i class="fas fa-palette"></i> CHOOSE YOUR THEME
                </div>
                <div class="theme-grid" id="themeGrid">
                    <button class="theme-btn" onclick="setTheme('rezero')">Re:Zero</button>
                    <button class="theme-btn" onclick="setTheme('mushoku')">Mushoku</button>
                    <button class="theme-btn" onclick="setTheme('sololeveling')">Solo Leveling</button>
                    <button class="theme-btn" onclick="setTheme('demonslayer')">Demon Slayer</button>
                    <button class="theme-btn" onclick="setTheme('onepiece')">One Piece</button>
                    <button class="theme-btn" onclick="setTheme('naruto')">Naruto</button>
                    <button class="theme-btn" onclick="setTheme('dbz')">Dragon Ball</button>
                    <button class="theme-btn" onclick="setTheme('aot')">Attack on Titan</button>
                    <button class="theme-btn" onclick="setTheme('jjk')">Jujutsu Kaisen</button>
                    <button class="theme-btn" onclick="setTheme('tokyoghoul')">Tokyo Ghoul</button>
                    <button class="theme-btn" onclick="setTheme('deathnote')">Death Note</button>
                    <button class="theme-btn" onclick="setTheme('chainsaw')">Chainsaw Man</button>
                    <button class="theme-btn" onclick="setTheme('seoul')">Seoul</button>
                    <button class="theme-btn" onclick="setTheme('busan')">Busan</button>
                    <button class="theme-btn" onclick="setTheme('jeju')">Jeju</button>
                    <button class="theme-btn" onclick="setTheme('tokyo')">Tokyo</button>
                    <button class="theme-btn" onclick="setTheme('kyoto')">Kyoto</button>
                    <button class="theme-btn" onclick="setTheme('ielts')">IELTS</button>
                    <button class="theme-btn" onclick="setTheme('academic')">Academic</button>
                    <button class="theme-btn" onclick="setTheme('writing')">Writing</button>
                </div>
            </div>

            <!-- STATISTICS GRID -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showStatsDetail('words')">
                    <div class="stat-value" id="totalWords">0</div>
                    <div class="stat-label">Words</div>
                    <div class="stat-trend trend-up" id="wordTrend">+12</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('mistakes')">
                    <div class="stat-value" id="totalMistakes">0</div>
                    <div class="stat-label">Mistakes</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('accuracy')">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('level')">
                    <div class="stat-value" id="userLevel">1</div>
                    <div class="stat-label">Level</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('xp')">
                    <div class="stat-value" id="userXP">0</div>
                    <div class="stat-label">XP</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('coins')">
                    <div class="stat-value" id="userCoins">0</div>
                    <div class="stat-label">Coins</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('streak')">
                    <div class="stat-value" id="streak">0</div>
                    <div class="stat-label">Streak</div>
                </div>
                <div class="stat-card" onclick="showStatsDetail('rank')">
                    <div class="stat-value" id="userRank">E</div>
                    <div class="stat-label">Band</div>
                </div>
            </div>

            <!-- MAIN MENU -->
            <div class="menu-grid">
                <div class="menu-card" onclick="openPage('addPage')">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Add Word</h3>
                    <p>‚ûï New vocabulary</p>
                    <div class="menu-progress" style="--progress: 75">
                        <svg><circle class="bg-circle" cx="20" cy="20" r="18"/><circle class="progress-circle" cx="20" cy="20" r="18"/></svg>
                        <span>75%</span>
                    </div>
                </div>
                <div class="menu-card" onclick="openPage('practicePage')">
                    <i class="fas fa-brain"></i>
                    <h3>Practice</h3>
                    <p>üéØ Test yourself</p>
                </div>
                <div class="menu-card" onclick="openPage('spellingPage')">
                    <i class="fas fa-font"></i>
                    <h3>Spelling</h3>
                    <p>üî§ Learn to spell</p>
                </div>
                <div class="menu-card" onclick="openPage('wordsPage')">
                    <i class="fas fa-book"></i>
                    <h3>My Words</h3>
                    <p>üìñ View all</p>
                </div>
                <div class="menu-card" onclick="openPage('ieltsPage')">
                    <i class="fas fa-graduation-cap"></i>
                    <h3>IELTS Packs</h3>
                    <p>üìö Academic words</p>
                </div>
                <div class="menu-card" onclick="openPage('chatPage')">
                    <i class="fas fa-comments"></i>
                    <h3>Messages</h3>
                    <p>üí¨ Chat</p>
                </div>
                <div class="menu-card" onclick="openPage('gamesPage')">
                    <i class="fas fa-gamepad"></i>
                    <h3>Games</h3>
                    <p>üéÆ Learn & Earn</p>
                </div>
                <div class="menu-card" onclick="openPage('rankingPage')">
                    <i class="fas fa-trophy"></i>
                    <h3>Ranking</h3>
                    <p>üèÜ Leaderboard</p>
                </div>
                <div class="menu-card" onclick="openPage('storePage')">
                    <i class="fas fa-store"></i>
                    <h3>Store</h3>
                    <p>üõí Word packs</p>
                </div>
                <div class="menu-card" onclick="openPage('statsPage')">
                    <i class="fas fa-chart-line"></i>
                    <h3>Statistics</h3>
                    <p>üìä Progress</p>
                </div>
                <div class="menu-card" onclick="openPage('achievementsPage')">
                    <i class="fas fa-medal"></i>
                    <h3>Achievements</h3>
                    <p>üèÖ Badges</p>
                </div>
                <div class="menu-card" onclick="openPage('voicePage')">
                    <i class="fas fa-microphone-alt"></i>
                    <h3>Voice Lab</h3>
                    <p>üîä Practice accent</p>
                </div>
            </div>

                        <!-- RECENT ACTIVITY -->
            <div class="recent-activity">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <h3 style="color: var(--primary);"><i class="fas fa-history"></i> Recent Activity</h3>
                    <button class="btn-small" onclick="clearActivity()">Clear</button>
                </div>
                <div id="activityFeed">
                    <div class="activity-item">
                        <div class="activity-icon">üìù</div>
                        <div class="activity-content">
                            <div class="activity-text">Added word "analyze"</div>
                            <div class="activity-time">2 minutes ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">üéØ</div>
                        <div class="activity-content">
                            <div class="activity-text">Scored 90% in practice</div>
                            <div class="activity-time">15 minutes ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">üí¨</div>
                        <div class="activity-content">
                            <div class="activity-text">Joined group "IELTS Masters"</div>
                            <div class="activity-time">1 hour ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">üèÜ</div>
                        <div class="activity-content">
                            <div class="activity-text">Earned achievement "First Word"</div>
                            <div class="activity-time">3 hours ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PAGES ========== -->

    <!-- ADD WORD PAGE -->
    <div id="addPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-plus-circle"></i> Add New Word</h2>
            <button class="close-btn" onclick="closePage('addPage')"><i class="fas fa-times"></i></button>
        </div>
        <div style="max-width: 600px; margin:0 auto;">
            <div class="form-group">
                <label>üìù English Word *</label>
                <input type="text" id="wordInput" placeholder="e.g., analyze">
            </div>
            <div class="form-group">
                <label>üá∫üáø Uzbek Meaning *</label>
                <input type="text" id="meaningInput" placeholder="e.g., tahlil qilmoq">
            </div>
            <div class="form-group">
                <label>üìö Part of Speech</label>
                <select id="posInput">
                    <option value="noun">Noun</option>
                    <option value="verb">Verb</option>
                    <option value="adjective">Adjective</option>
                    <option value="adverb">Adverb</option>
                </select>
            </div>
            <div class="form-group">
                <label>üîÑ Synonyms <span class="ai-badge"><i class="fas fa-magic"></i> AI Suggest</span></label>
                <input type="text" id="synonymsInput" placeholder="e.g., examine, inspect">
                <div class="synonym-suggestions" id="synonymSuggestions"></div>
            </div>
            <div class="form-group">
                <label>üìÇ Category</label>
                <select id="categoryInput">
                    <option value="general">General</option>
                    <option value="academic">Academic</option>
                    <option value="ielts">IELTS</option>
                </select>
            </div>
            <div class="form-group">
                <label>üí¨ Example Sentence</label>
                <textarea id="exampleInput" rows="2"></textarea>
            </div>
            <button class="btn" onclick="addWord()">Save Word (+1 coin)</button>
            <button class="btn btn-secondary" onclick="closePage('addPage')">Cancel</button>
        </div>
    </div>

    <!-- IELTS WORD PACKS PAGE -->
    <div id="ieltsPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-graduation-cap"></i> IELTS Learning Path</h2>
            <button class="close-btn" onclick="closePage('ieltsPage')"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="learning-path">
            <div class="path-header">
                <div class="path-title">Band 5 ‚Üí 6</div>
                <div class="path-progress">
                    <div class="progress-bar"><div class="progress-fill" style="width:60%"></div></div>
                </div>
            </div>
            <div class="badge-container">
                <div class="badge unlocked">ü•â</div>
                <div class="badge unlocked">üìò</div>
                <div class="badge locked">üéØ</div>
            </div>
        </div>

        <div class="store-grid">
            <div class="store-item popular" onclick="loadIELTSPack('academic1')">
                <div class="item-icon">üìö</div>
                <div class="item-name">Academic Pack 1</div>
                <div class="item-desc">50 essential academic words</div>
                <div class="item-price">FREE</div>
                <button class="buy-btn">Load Words</button>
            </div>
            <div class="store-item" onclick="loadIELTSPack('increase')">
                <div class="item-icon">üìà</div>
                <div class="item-name">Increase Synonyms</div>
                <div class="item-desc">15 words for "increase"</div>
                <div class="item-price">FREE</div>
                <button class="buy-btn">Load Words</button>
            </div>
            <div class="store-item" onclick="loadIELTSPack('decrease')">
                <div class="item-icon">üìâ</div>
                <div class="item-name">Decrease Synonyms</div>
                <div class="item-desc">15 words for "decrease"</div>
                <div class="item-price">FREE</div>
                <button class="buy-btn">Load Words</button>
            </div>
            <div class="store-item" onclick="loadIELTSPack('writing1')">
                <div class="item-icon">‚úçÔ∏è</div>
                <div class="item-name">Writing Task 1</div>
                <div class="item-desc">50 graph words</div>
                <div class="item-price">100 ü™ô</div>
                <button class="buy-btn">Buy</button>
            </div>
        </div>
        
        <div style="margin-top:20px;">
            <div class="progress-bar"><div class="progress-fill" id="ieltsProgress" style="width:0%"></div></div>
            <p id="ieltsStats" style="text-align:center;">0/65 IELTS words mastered</p>
        </div>
    </div>

    <!-- WORDS PAGE -->
    <div id="wordsPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-book"></i> My Vocabulary</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn-small" onclick="toggleViewMode()" title="Toggle view">
                    <i class="fas" id="viewModeIcon">fa-th-large</i>
                </button>
                <button class="btn-small" onclick="exportVocabulary()" title="Export">
                    <i class="fas fa-download"></i>
                </button>
                <button class="close-btn" onclick="closePage('wordsPage')">‚úï</button>
            </div>
        </div>

        <div class="words-controls">
            <div class="filter-bar">
                <input type="text" id="searchInput" placeholder="üîç Search words..." oninput="debounceSearch()" style="flex:2; padding:12px;">
                <select id="filterCategory" class="filter-select" onchange="applyFilters()" style="flex:1;">
                    <option value="all">All Categories</option>
                    <option value="ielts">IELTS</option>
                    <option value="academic">Academic</option>
                    <option value="general">General</option>
                </select>
                <select id="filterMastery" class="filter-select" onchange="applyFilters()" style="flex:1;">
                    <option value="all">All Levels</option>
                    <option value="weak">Weak</option>
                    <option value="learning">Learning</option>
                    <option value="mastered">Mastered</option>
                </select>
            </div>
        </div>

        <div id="wordsContainer" class="word-grid"></div>
    </div>

    <!-- PRACTICE PAGE -->
    <div id="practicePage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-brain"></i> Practice</h2>
            <button class="close-btn" onclick="closePage('practicePage')"><i class="fas fa-times"></i></button>
        </div>
        <div class="practice-container">
            <div class="practice-word" id="practiceWord">---</div>
            
            <!-- Voice System -->
            <div class="voice-system">
                <div class="big-button-grid">
                    <button class="big-voice-btn" onclick="speakWord()"><i class="fas fa-volume-up"></i></button>
                    <button class="big-voice-btn" onclick="repeatWord()"><i class="fas fa-redo-alt"></i></button>
                    <button class="big-voice-btn" onclick="slowWord()"><i class="fas fa-turtle"></i></button>
                    <button class="big-voice-btn" onclick="spellCurrentWord()"><i class="fas fa-font"></i></button>
                </div>
                
                <div class="accent-selector">
                    <button class="accent-btn active" onclick="setAccent('us')">üá∫üá∏ US</button>
                    <button class="accent-btn" onclick="setAccent('uk')">üá¨üáß UK</button>
                    <button class="accent-btn" onclick="setAccent('au')">üá¶üá∫ AU</button>
                </div>

                <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0;">
                    <span>Speed:</span>
                    <input type="range" min="0.3" max="2" step="0.1" value="1" class="voice-speed-slider" oninput="adjustSpeed(this.value)" style="flex:1;">
                    <span id="voiceSpeedDisplay">1.0x</span>
                </div>

                <div class="pronunciation-meter">
                    <div class="pronunciation-fill" id="pronunciationScore" style="width:0%"></div>
                </div>
            </div>

            <div id="wordInfo" style="margin:15px 0; padding:15px; background:var(--surface-light); border-radius:16px;"></div>
            
            <input type="text" id="practiceAnswer" placeholder="Type meaning..." style="width:100%; padding:15px; margin:10px 0;">
            
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <p id="progressText">0/0</p>
            
            <div id="practiceFeedback" style="min-height:40px;"></div>
            
            <button class="btn" onclick="checkAnswer()">Submit</button>
            <button class="btn btn-secondary" onclick="skipWord()">Skip</button>
        </div>
    </div>

    <!-- SPELLING PAGE -->
    <div id="spellingPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-font"></i> Spelling Practice</h2>
            <button class="close-btn" onclick="closePage('spellingPage')"><i class="fas fa-times"></i></button>
        </div>
        <div class="practice-container">
            <div style="background:var(--surface-light); padding:20px; border-radius:20px; margin-bottom:20px;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <span>Spelling Speed:</span>
                    <input type="range" id="spellingSpeedSlider" min="0.3" max="1.5" step="0.1" value="0.8" oninput="updateSpellingSpeed(this.value)" style="flex:1;">
                    <span id="spellingSpeedDisplay">0.8x</span>
                </div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-small" onclick="setSpellingSpeed(0.5)">üê¢ Slow</button>
                    <button class="btn-small" onclick="setSpellingSpeed(0.8)">üö∂ Normal</button>
                    <button class="btn-small" onclick="setSpellingSpeed(1.2)">‚ö° Fast</button>
                </div>
            </div>
            <div id="spellingArea"></div>
        </div>
    </div>

    <!-- VOICE LAB PAGE -->
    <div id="voicePage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-microphone-alt"></i> Pronunciation Lab</h2>
            <button class="close-btn" onclick="closePage('voicePage')"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="voice-system" style="max-width:600px; margin:0 auto;">
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:48px; font-weight:800; color:var(--primary);" id="voiceLabWord">Hello</div>
                <div class="phonetic-display" id="phonetic">/h…ôÀàl…ô ä/</div>
            </div>

            <div class="big-button-grid">
                <button class="big-voice-btn" onclick="speakLabWord()"><i class="fas fa-volume-up"></i></button>
                <button class="big-voice-btn" onclick="startRecording()"><i class="fas fa-microphone"></i></button>
                <button class="big-voice-btn" onclick="playRecording()"><i class="fas fa-play"></i></button>
                <button class="big-voice-btn" onclick="comparePronunciation()"><i class="fas fa-check"></i></button>
            </div>

            <div class="waveform-container" id="waveform">
                <div class="waveform-bar" style="animation-delay:0s"></div>
                <div class="waveform-bar" style="animation-delay:0.1s"></div>
                <div class="waveform-bar" style="animation-delay:0.2s"></div>
                <div class="waveform-bar" style="animation-delay:0.3s"></div>
                <div class="waveform-bar" style="animation-delay:0.4s"></div>
            </div>

            <div class="pronunciation-meter">
                <div class="pronunciation-fill" id="labPronunciationScore" style="width:75%"></div>
            </div>
            <p style="text-align:center;">Score: 75% - Good!</p>

            <div class="accent-selector" style="justify-content:center;">
                <button class="accent-btn active" onclick="setLabAccent('us')">üá∫üá∏ American</button>
                <button class="accent-btn" onclick="setLabAccent('uk')">üá¨üáß British</button>
                <button class="accent-btn" onclick="setLabAccent('au')">üá¶üá∫ Australian</button>
            </div>
            
            <div style="margin-top:20px;">
                <select id="labWordSelector" class="filter-select" style="width:100%; padding:12px;" onchange="changeLabWord()">
                    <option value="hello">Hello</option>
                    <option value="world">World</option>
                    <option value="analyze">Analyze</option>
                    <option value="significant">Significant</option>
                </select>
            </div>
        </div>
    </div>

    <!-- GAMES PAGE -->
    <div id="gamesPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-gamepad"></i> Vocabulary Games</h2>
            <button class="close-btn" onclick="closePage('gamesPage')"><i class="fas fa-times"></i></button>
        </div>

        <div class="games-grid">
            <div class="game-card" onclick="startGame('match')">
                <div class="game-icon">üéØ</div>
                <div class="game-title">Word Match</div>
                <div class="game-desc">Match words with meanings</div>
                <span class="badge" style="background:gold; padding:3px 8px; border-radius:12px;">+50 coins</span>
            </div>
            <div class="game-card" onclick="startGame('race')">
                <div class="game-icon">‚úçÔ∏è</div>
                <div class="game-title">Typing Race</div>
                <div class="game-desc">Type before time runs out</div>
            </div>
            <div class="game-card" onclick="startGame('scramble')">
                <div class="game-icon">üî§</div>
                <div class="game-title">Word Scramble</div>
                <div class="game-desc">Unscramble the letters</div>
            </div>
            <div class="game-card" onclick="startGame('listen')">
                <div class="game-icon">üéß</div>
                <div class="game-title">Listening Challenge</div>
                <div class="game-desc">Hear and choose</div>
            </div>
        </div>

        <div id="gameArea" class="game-area" style="display:none;">
            <div class="game-word" id="gameWord">_____</div>
            <div class="game-options" id="gameOptions"></div>
            <div class="game-timer">
                <div class="timer-fill" id="gameTimer" style="width:100%"></div>
            </div>
            <div class="game-score" id="gameScore">0</div>
            <button class="btn" onclick="endGame()" style="margin-top:15px;">End Game</button>
        </div>
    </div>

    <!-- CHAT PAGE -->
    <div id="chatPage" class="page">
        <div class="page-header" style="padding: 10px;">
            <h2 style="font-size: 20px;"><i class="fab fa-telegram"></i> IELTS Chat</h2>
            <div style="display: flex; gap: 5px;">
                <button class="btn-small" onclick="createGroup()" style="padding: 8px 12px;">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn-small" onclick="joinGroup()" style="padding: 8px 12px;">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
                <button class="close-btn" onclick="closePage('chatPage')" style="width: 35px; height: 35px;">‚úï</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="groups-scroll">
                <div id="groupsList"></div>
            </div>

            <div class="chat-area">
                <div class="chat-header">
                    <div>
                        <h3 id="currentGroupName" style="font-size:16px;">Select Group</h3>
                        <span id="memberCount">0 members</span>
                    </div>
                    <div id="groupActions" style="display:none;">
                        <button class="btn-small" onclick="showGroupInfo()"><i class="fas fa-info-circle"></i></button>
                        <button class="btn-small" onclick="showMembers()"><i class="fas fa-users"></i></button>
                        <button class="btn-small" onclick="leaveGroup()" style="background:var(--danger);"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>

                <div id="chatMessages" class="chat-messages"></div>

                <div id="messageInput" class="chat-input-area" style="display:none;">
                    <div class="chat-input-wrapper">
                        <input type="text" id="messageText" class="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Sidebar -->
        <div id="membersSidebar" class="modal" style="display:none;">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Members</h3>
                    <button class="close-btn" onclick="hideMembers()" style="width:30px; height:30px;">‚úï</button>
                </div>
                <div id="membersList"></div>
            </div>
        </div>
        
        <!-- Group Info Sidebar -->
        <div id="groupInfoSidebar" class="modal" style="display:none;">
            <div class="modal-content">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Group Info</h3>
                    <button class="close-btn" onclick="hideGroupInfo()" style="width:30px; height:30px;">‚úï</button>
                </div>
                <div id="groupInfoContent"></div>
            </div>
        </div>
    </div>

    <!-- STORE PAGE -->
    <div id="storePage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-store"></i> IELTS Store</h2>
            <button class="close-btn" onclick="closePage('storePage')"><i class="fas fa-times"></i></button>
        </div>
        
        <div style="text-align:center; margin-bottom:20px;">
            <span style="font-size:24px;">Your Balance: <span id="storeCoins">0</span> ü™ô</span>
        </div>

        <div class="store-grid" id="storeItems">
            <div class="store-item popular">
                <div class="item-icon">‚ö°</div>
                <div class="item-name">XP Boost</div>
                <div class="item-desc">Double XP for 1 hour</div>
                <div class="item-price">50 ü™ô</div>
                <button class="buy-btn" onclick="buyItem('xp')">Buy</button>
            </div>
            <div class="store-item">
                <div class="item-icon">üìö</div>
                <div class="item-name">Word Pack</div>
                <div class="item-desc">20 random words</div>
                <div class="item-price">80 ü™ô</div>
                <button class="buy-btn" onclick="buyItem('pack')">Buy</button>
            </div>
            <div class="store-item">
                <div class="item-icon">üé®</div>
                <div class="item-name">Custom Theme</div>
                <div class="item-desc">Unlock all themes</div>
                <div class="item-price">200 ü™ô</div>
                <button class="buy-btn" onclick="buyItem('theme')">Buy</button>
            </div>
            <div class="store-item">
                <div class="item-icon">‚ùÑÔ∏è</div>
                <div class="item-name">Streak Freeze</div>
                <div class="item-desc">Protect streak for 24h</div>
                <div class="item-price">30 ü™ô</div>
                <button class="buy-btn" onclick="buyItem('freeze')">Buy</button>
            </div>
        </div>
    </div>

    <!-- RANKING PAGE -->
    <div id="rankingPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-trophy"></i> Global Ranking</h2>
            <button class="close-btn" onclick="closePage('rankingPage')"><i class="fas fa-times"></i></button>
        </div>

        <div class="ranking-tabs">
            <div class="ranking-tab active" onclick="switchRankingTab('global')">Global</div>
            <div class="ranking-tab" onclick="switchRankingTab('friends')">Friends</div>
            <div class="ranking-tab" onclick="switchRankingTab('weekly')">Weekly</div>
        </div>

        <div class="ranking-list" id="rankingList"></div>
    </div>

    <!-- STATISTICS PAGE -->
    <div id="statsPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-chart-line"></i> Learning Analytics</h2>
            <button class="close-btn" onclick="closePage('statsPage')"><i class="fas fa-times"></i></button>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-title">Total Words</div>
                <div class="summary-value" id="statTotalWords">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-title">Mastery Rate</div>
                <div class="summary-value" id="statMastery">0%</div>
            </div>
            <div class="summary-card">
                <div class="summary-title">Streak</div>
                <div class="summary-value" id="statStreak">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-title">Level</div>
                <div class="summary-value" id="statLevel">1</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="progressChart" style="height:300px;"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="categoryChart" style="height:250px;"></canvas>
        </div>

        <div class="heatmap-container">
            <h3 style="margin-bottom:15px;">üìÖ Activity Heatmap</h3>
            <div class="heatmap-grid" id="heatmap"></div>
        </div>

        <div class="weak-words-section">
            <h3>Words to Review</h3>
            <div id="weakWords" class="weak-words-grid"></div>
        </div>
    </div>

    <!-- ACHIEVEMENTS PAGE -->
    <div id="achievementsPage" class="page">
        <div class="page-header">
            <h2><i class="fas fa-medal"></i> Achievements</h2>
            <button class="close-btn" onclick="closePage('achievementsPage')"><i class="fas fa-times"></i></button>
        </div>
        <div id="achievementsContainer" class="store-grid"></div>
    </div>

    <!-- VERIFICATION MODAL -->
    <div id="verificationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">Verify Email</h3>
            <p style="margin-bottom:15px;">Enter 6-digit code sent to your email</p>
            <input type="text" id="verificationCode" placeholder="000000" style="width:100%; padding:15px; text-align:center; font-size:20px; margin-bottom:15px;">
            <button class="btn" onclick="verifyEmail()" style="width:100%;">Verify</button>
            <p style="text-align:center; margin-top:10px;">
                <a href="#" onclick="resendCode()">Resend code</a>
            </p>
        </div>
    </div>

    <!-- FORGOT PASSWORD MODAL -->
    <div id="forgotPasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-bottom:15px;">Reset Password</h3>
            <p style="margin-bottom:15px;">Enter your email to receive reset link</p>
            <input type="email" id="resetEmail" placeholder="your@email.com" style="width:100%; padding:15px; margin-bottom:15px;">
            <button class="btn" onclick="sendResetLink()" style="width:100%;">Send Reset Link</button>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const MASTER = {
            email: 'ayanakoji4@gmail.com',
            name: 'Ayanakoji Kiyotaka',
            username: 'Monster',
            coins: Infinity,
            password: btoa('Monster123')
        };

        // ========== DATA STORAGE ==========
        let users = JSON.parse(localStorage.getItem('vt_users')) || {};
        let currentUser = localStorage.getItem('vt_current') || null;

        // Add master account if not exists
        if (!Object.values(users).some(u => u.email === MASTER.email)) {
            let masterId = 'master_' + Date.now();
            users[masterId] = {
                id: masterId,
                username: MASTER.username,
                name: MASTER.name,
                email: MASTER.email,
                password: MASTER.password,
                createdAt: new Date().toISOString(),
                vocabulary: [],
                mistakes: [],
                history: [],
                xp: 999999,
                coins: Infinity,
                streak: 999,
                level: 100,
                ieltsWords: 1000,
                avatar: 'üëë',
                isMaster: true
            };
            localStorage.setItem('vt_users', JSON.stringify(users));
        }

        // Current user data
        let vocabulary = [];
        let mistakes = [];
        let history = [];
        let xp = 0;
        let level = 1;
        let coins = 0;
        let streak = 0;
        let ieltsWords = 0;

        // Practice session
        let currentSession = [];
        let currentIndex = 0;
        let correct = 0;
        let wrong = [];
        let startTime = null;

        // Voice
        let voiceEnabled = true;
        let voiceSpeed = 1.0;
        let synth = window.speechSynthesis;
        let voices = [];
        let currentVoice = null;

        // Spelling speed
        let spellingSpeed = 0.8;

        // Chat data
        let chatGroups = JSON.parse(localStorage.getItem('chat_groups')) || {};
        let chatMessages = JSON.parse(localStorage.getItem('chat_messages')) || {};
        let currentGroup = null;
        let chatTimer = null;

        // Activity feed
        let activities = JSON.parse(localStorage.getItem('activities')) || [];

        // ========== INIT ==========
        function init() {
            let savedTheme = localStorage.getItem('vt_theme') || 'rezero';
            setTheme(savedTheme);

            if (currentUser) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadUserData();
                updateIELTSProgress();
                renderActivity();
            }

            initVoice();
            initChat();
            updateUI();
        }

        // ========== ACTIVITY FUNCTIONS ==========
        function addActivity(icon, text) {
            activities.unshift({
                icon: icon,
                text: text,
                time: new Date().toISOString()
            });
            if (activities.length > 10) activities.pop();
            localStorage.setItem('activities', JSON.stringify(activities));
            renderActivity();
        }

        function renderActivity() {
            let feed = document.getElementById('activityFeed');
            if (!feed) return;
            
            if (activities.length === 0) {
                feed.innerHTML = '<div class="activity-item"><div class="activity-icon">üëã</div><div class="activity-content">No recent activity</div></div>';
                return;
            }
            
            feed.innerHTML = activities.map(a => {
                let timeAgo = getTimeAgo(new Date(a.time));
                return `
                    <div class="activity-item">
                        <div class="activity-icon">${a.icon}</div>
                        <div class="activity-content">
                            <div class="activity-text">${a.text}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            let seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        function clearActivity() {
            activities = [];
            localStorage.setItem('activities', JSON.stringify(activities));
            renderActivity();
            showNotification('Activity cleared', 'info');
        }

        // ========== AUTH ==========
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(el => el.classList.remove('active'));
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function checkPasswordStrength() {
            let pass = document.getElementById('regPassword').value;
            let bar = document.getElementById('strengthBar');
            let text = document.getElementById('strengthText');
            
            let strength = 0;
            if (pass.length >= 8) strength++;
            if (/[a-z]/.test(pass)) strength++;
            if (/[A-Z]/.test(pass)) strength++;
            if (/[0-9]/.test(pass)) strength++;
            if (/[^a-zA-Z0-9]/.test(pass)) strength++;
            
            let width = (strength / 5) * 100;
            bar.style.width = width + '%';
            
            if (strength <= 2) {
                bar.className = 'strength-bar strength-weak';
                text.innerText = 'Weak password';
            } else if (strength <= 4) {
                bar.className = 'strength-bar strength-medium';
                text.innerText = 'Medium password';
            } else {
                bar.className = 'strength-bar strength-strong';
                text.innerText = 'Strong password';
            }
        }

        let pendingUser = null;

        function registerUser() {
            let username = document.getElementById('regUsername').value.trim();
            let name = document.getElementById('regName').value.trim();
            let email = document.getElementById('regEmail').value.trim();
            let pass = document.getElementById('regPassword').value;
            let confirm = document.getElementById('regConfirmPassword').value;

            if (!username || !name || !email || !pass) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            if (pass.length < 8) {
                showNotification('Password must be 8+ characters', 'error');
                return;
            }
            if (pass !== confirm) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            let users = JSON.parse(localStorage.getItem('vt_users')) || {};
            for (let id in users) {
                if (users[id].username === username) {
                    showNotification('Username taken', 'error');
                    return;
                }
                if (users[id].email === email) {
                    showNotification('Email already registered', 'error');
                    return;
                }
            }

            let code = Math.floor(100000 + Math.random() * 900000).toString();
            pendingUser = {
                username, name, email,
                password: btoa(pass),
                createdAt: new Date().toISOString(),
                vocabulary: [], mistakes: [], history: [],
                xp: 0, coins: 100, streak: 0, level: 1, ieltsWords: 0,
                avatar: 'üë§',
                verified: false,
                verificationCode: code
            };

            console.log('Verification code:', code);
            showNotification('Verification code sent to ' + email, 'info');
            document.getElementById('verificationModal').style.display = 'flex';
        }

        function verifyEmail() {
            let code = document.getElementById('verificationCode').value.trim();
            if (!pendingUser) {
                showNotification('No pending registration', 'error');
                return;
            }
            if (code === pendingUser.verificationCode) {
                pendingUser.verified = true;
                delete pendingUser.verificationCode;
                
                let users = JSON.parse(localStorage.getItem('vt_users')) || {};
                let userId = 'user_' + Date.now();
                users[userId] = pendingUser;
                localStorage.setItem('vt_users', JSON.stringify(users));
                
                localStorage.setItem('vt_current', userId);
                currentUser = userId;
                
                showNotification('‚úÖ Email verified! Welcome!', 'success');
                document.getElementById('verificationModal').style.display = 'none';
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadUserData();
                addActivity('üìù', 'Registered and verified email');
                confetti({ particleCount: 100 });
                
                pendingUser = null;
            } else {
                showNotification('‚ùå Incorrect code', 'error');
            }
        }

        function resendCode() {
            if (pendingUser) {
                pendingUser.verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
                console.log('New code:', pendingUser.verificationCode);
                showNotification('New code sent (check console)', 'info');
            }
        }

        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').style.display = 'flex';
        }

        function sendResetLink() {
            let email = document.getElementById('resetEmail').value.trim();
            showNotification('Reset link sent to ' + email, 'success');
            document.getElementById('forgotPasswordModal').style.display = 'none';
        }

        function closeVerificationModal() {
            document.getElementById('verificationModal').style.display = 'none';
        }

        function loginUser() {
            let input = document.getElementById('loginUsername').value.trim();
            let pass = document.getElementById('loginPassword').value;
            let remember = document.getElementById('rememberMe').checked;

            let users = JSON.parse(localStorage.getItem('vt_users')) || {};
            let hashed = btoa(pass);

            for (let id in users) {
                let u = users[id];
                if ((u.username === input || u.email === input) && u.password === hashed) {
                    localStorage.setItem('vt_current', id);
                    if (remember) {
                        localStorage.setItem('vt_remember', 'true');
                    }
                    currentUser = id;
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadUserData();
                    addActivity('üîì', 'Logged in');
                    showNotification('Welcome back, ' + u.name, 'success');
                    return;
                }
            }
            showNotification('Invalid credentials', 'error');
        }

        function logout() {
            localStorage.removeItem('vt_current');
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showNotification('Logged out', 'info');
        }

        function showNotification(msg, type = 'info') {
            let n = document.createElement('div');
            n.className = 'notification ' + type;
            n.innerText = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        // ========== USER DATA ==========
        function loadUserData() {
            if (!currentUser) return;
            let u = users[currentUser];
            if (!u) { logout(); return; }
            
            vocabulary = u.vocabulary || [];
            mistakes = u.mistakes || [];
            history = u.history || [];
            xp = u.xp || 0;
            coins = u.coins || 0;
            streak = u.streak || 0;
            ieltsWords = u.ieltsWords || 0;
            
            if (u.isMaster) coins = Infinity;
            
            calculateLevel();
            updateUI();
            document.getElementById('userAvatar').innerText = u.avatar || 'üë§';
            document.getElementById('userName').innerText = u.name || 'User';
        }

        function saveUserData() {
            if (!currentUser) return;
            let u = users[currentUser];
            if (!u) return;
            
            u.vocabulary = vocabulary;
            u.mistakes = mistakes;
            u.history = history;
            u.xp = xp;
            u.coins = coins;
            u.streak = streak;
            u.level = level;
            u.ieltsWords = ieltsWords;
            
            localStorage.setItem('vt_users', JSON.stringify(users));
        }

        function updateUI() {
            document.getElementById('totalWords').innerText = vocabulary.length;
            document.getElementById('totalMistakes').innerText = mistakes.length;
            
            let totalCorrect = vocabulary.reduce((s, w) => s + (w.correct || 0), 0);
            let totalAttempts = vocabulary.reduce((s, w) => s + (w.correct || 0) + (w.wrong || 0), 0);
            let acc = totalAttempts ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            document.getElementById('accuracy').innerText = acc + '%';
            
            document.getElementById('userLevel').innerText = level;
            document.getElementById('userXP').innerText = xp;
            document.getElementById('userCoins').innerText = coins === Infinity ? '‚àû' : Math.floor(coins);
            document.getElementById('coinDisplay').innerText = coins === Infinity ? '‚àû' : Math.floor(coins);
            document.getElementById('streak').innerText = streak;
            
            let rank = getRank();
            document.getElementById('userRank').innerText = rank.name;
            document.getElementById('rankDisplay').innerText = rank.name;
        }

        function calculateLevel() {
            level = Math.floor(xp / 100) + 1;
        }

        function getRank() {
            if (xp < 100) return { name: 'Bronze', color: 'bronze' };
            if (xp < 300) return { name: 'Silver', color: 'silver' };
            if (xp < 600) return { name: 'Gold', color: 'gold' };
            if (xp < 1000) return { name: 'Platinum', color: 'platinum' };
            return { name: 'Diamond', color: 'diamond' };
        }

        // ========== WORD PACKS ==========
        const IELTS_WORDS = {
            academic1: [
                { word: 'analyze', meaning: 'tahlil qilmoq', category: 'academic' },
                { word: 'approach', meaning: 'yondashuv', category: 'academic' },
                { word: 'assess', meaning: 'baholamoq', category: 'academic' }
            ],
            increase: [
                { word: 'rise', meaning: 'ko ªtarilmoq', category: 'ielts' },
                { word: 'surge', meaning: 'keskin oshmoq', category: 'ielts' }
            ],
            decrease: [
                { word: 'decline', meaning: 'kamaymoq', category: 'ielts' },
                { word: 'plummet', meaning: 'keskin tushmoq', category: 'ielts' }
            ],
            writing1: [
                { word: 'graph', meaning: 'grafik', category: 'writing' },
                { word: 'chart', meaning: 'diagramma', category: 'writing' }
            ]
        };

        function loadIELTSPack(packName) {
            let pack = IELTS_WORDS[packName];
            if (!pack) return;
            
            let added = 0;
            pack.forEach(w => {
                if (!vocabulary.some(v => v.word === w.word)) {
                    vocabulary.push({
                        id: Date.now() + added,
                        ...w,
                        correct: 0, wrong: 0,
                        added: new Date().toISOString()
                    });
                    added++;
                    if (w.category === 'ielts' || w.category === 'academic') ieltsWords++;
                }
            });
            
            if (added > 0) {
                showNotification(`Added ${added} words!`, 'success');
                saveUserData();
                updateUI();
                updateIELTSProgress();
                addActivity('üì¶', `Loaded ${packName} word pack`);
                confetti({ particleCount: 50 });
            } else {
                showNotification('All words already exist', 'info');
            }
        }

        function updateIELTSProgress() {
            let total = Object.values(IELTS_WORDS).reduce((s, a) => s + a.length, 0);
            let pct = (ieltsWords / total) * 100;
            document.getElementById('ieltsProgress').style.width = pct + '%';
            document.getElementById('ieltsStats').innerText = ieltsWords + '/' + total + ' IELTS words';
        }

        // ========== WORDS ==========
        function addWord() {
            let word = document.getElementById('wordInput').value.trim();
            let meaning = document.getElementById('meaningInput').value.trim();
            if (!word || !meaning) {
                showNotification('Enter word and meaning', 'error');
                return;
            }
            
            vocabulary.push({
                id: Date.now(),
                word, meaning,
                pos: document.getElementById('posInput').value,
                synonyms: document.getElementById('synonymsInput').value,
                category: document.getElementById('categoryInput').value,
                example: document.getElementById('exampleInput').value,
                correct: 0, wrong: 0,
                added: new Date().toISOString()
            });
            
            coins += 1;
            xp += 15;
            saveUserData();
            updateUI();
            addActivity('üìù', `Added word "${word}"`);
            
            document.getElementById('wordInput').value = '';
            document.getElementById('meaningInput').value = '';
            document.getElementById('synonymsInput').value = '';
            document.getElementById('exampleInput').value = '';
            
            showNotification('Word added! +1 coin', 'success');
            renderWords();
        }

        function renderWords() {
            let container = document.getElementById('wordsContainer');
            if (!container) return;
            
            if (!vocabulary.length) {
                container.innerHTML = '<div style="text-align:center; padding:50px;">No words yet. Add some!</div>';
                return;
            }
            
            container.innerHTML = vocabulary.map(w => {
                let mastery = 'learning';
                let masteryClass = 'mastery-learning';
                if ((w.correct || 0) > 5) {
                    mastery = 'Mastered';
                    masteryClass = 'mastery-mastered';
                } else if ((w.wrong || 0) > 3) {
                    mastery = 'Weak';
                    masteryClass = 'mastery-weak';
                } else {
                    mastery = 'Learning';
                    masteryClass = 'mastery-learning';
                }
                
                return `
                <div class="word-card">
                    <span class="mastery-badge ${masteryClass}">${mastery}</span>
                    <div class="word">${w.word}</div>
                    <div class="meaning">${w.meaning}</div>
                    ${w.synonyms ? `<div style="font-size:12px; color:#2ecc71;">üìà ${w.synonyms}</div>` : ''}
                    ${w.example ? `<div style="font-size:12px; font-style:italic; margin-top:5px;">"${w.example}"</div>` : ''}
                    <div class="word-actions">
                        <button onclick="speakText('${w.word}')"><i class="fas fa-volume-up"></i></button>
                        <button onclick="spellWord('${w.word}')"><i class="fas fa-font"></i></button>
                        <button onclick="deleteWord(${w.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `}).join('');
        }

        function deleteWord(id) {
            if (!confirm('Delete this word?')) return;
            vocabulary = vocabulary.filter(w => w.id !== id);
            mistakes = mistakes.filter(m => m.id !== id);
            saveUserData();
            renderWords();
            updateUI();
            showNotification('Word deleted', 'info');
        }

        function searchWords() {
            let q = document.getElementById('searchInput').value.toLowerCase();
            let filtered = vocabulary.filter(w => 
                w.word.toLowerCase().includes(q) || 
                w.meaning.toLowerCase().includes(q) ||
                (w.synonyms && w.synonyms.toLowerCase().includes(q))
            );
            
            let container = document.getElementById('wordsContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px;">No words found</div>';
                return;
            }
            
            container.innerHTML = filtered.map(w => `
                <div class="word-card">
                    <div class="word">${w.word}</div>
                    <div class="meaning">${w.meaning}</div>
                </div>
            `).join('');
        }

        let searchTimeout;
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchWords, 300);
        }

        function applyFilters() {
            let category = document.getElementById('filterCategory').value;
            let mastery = document.getElementById('filterMastery').value;
            
            let filtered = vocabulary.filter(w => {
                if (category !== 'all' && w.category !== category) return false;
                if (mastery === 'weak' && (w.wrong || 0) <= 3) return false;
                if (mastery === 'mastered' && (w.correct || 0) <= 5) return false;
                if (mastery === 'learning' && ((w.correct || 0) > 5 || (w.wrong || 0) > 3)) return false;
                return true;
            });
            
            let container = document.getElementById('wordsContainer');
            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px;">No words match filters</div>';
                return;
            }
            
            container.innerHTML = filtered.map(w => `
                <div class="word-card">
                    <div class="word">${w.word}</div>
                    <div class="meaning">${w.meaning}</div>
                </div>
            `).join('');
        }

        function toggleViewMode() {
            let icon = document.getElementById('viewModeIcon');
            if (icon.classList.contains('fa-th-large')) {
                icon.classList.remove('fa-th-large');
                icon.classList.add('fa-list');
            } else {
                icon.classList.remove('fa-list');
                icon.classList.add('fa-th-large');
            }
        }

        function exportVocabulary() {
            let data = JSON.stringify(vocabulary, null, 2);
            let blob = new Blob([data], {type: 'application/json'});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'vocabulary.json';
            a.click();
            showNotification('Vocabulary exported!', 'success');
        }

        // ========== PRACTICE ==========
        function startPractice() {
            if (!vocabulary.length) {
                showNotification('Add some words first!', 'error');
                closePage('practicePage');
                return;
            }
            
            if (voiceEnabled && speechSynthesis) speechSynthesis.cancel();
            
            // Prioritize weak words
            let weakWords = vocabulary.filter(w => (w.wrong || 0) > 2);
            let otherWords = vocabulary.filter(w => (w.wrong || 0) <= 2);
            
            currentSession = [];
            if (weakWords.length) {
                currentSession.push(...weakWords.slice(0, 5));
            }
            if (currentSession.length < 10) {
                currentSession.push(...otherWords.slice(0, 10 - currentSession.length));
            }
            
            currentSession = currentSession.sort(() => 0.5 - Math.random());
            currentIndex = 0;
            correct = 0;
            wrong = [];
            startTime = Date.now();
            
            showNextWord();
        }

        function showNextWord() {
            if (currentIndex >= currentSession.length) {
                endPractice();
                return;
            }
            
            let w = currentSession[currentIndex];
            document.getElementById('practiceWord').innerText = w.word;
            document.getElementById('practiceAnswer').value = '';
            document.getElementById('practiceFeedback').innerHTML = '';
            
            let info = document.getElementById('wordInfo');
            info.innerHTML = '';
            if (w.synonyms) info.innerHTML += `<div>üìà Synonyms: ${w.synonyms}</div>`;
            if (w.antonyms) info.innerHTML += `<div>üìâ Antonyms: ${w.antonyms}</div>`;
            
            let prog = (currentIndex / currentSession.length) * 100;
            document.getElementById('progressFill').style.width = prog + '%';
            document.getElementById('progressText').innerText = (currentIndex+1) + '/' + currentSession.length;
            
            if (voiceEnabled) setTimeout(() => speakText(w.word), 300);
        }

        function checkAnswer() {
            let ans = document.getElementById('practiceAnswer').value.trim().toLowerCase();
            let w = currentSession[currentIndex];
            let correctAns = w.meaning.toLowerCase();
            
            if (ans === correctAns) {
                document.getElementById('practiceFeedback').innerHTML = '<span style="color:var(--success);">‚úÖ Correct! +0.3 coins</span>';
                w.correct = (w.correct || 0) + 1;
                correct++;
                coins += 0.3;
                xp += 8;
                
                // Remove from mistakes if was there
                mistakes = mistakes.filter(m => m.id !== w.id);
            } else {
                document.getElementById('practiceFeedback').innerHTML = '<span style="color:var(--danger);">‚ùå Wrong! Correct: ' + w.meaning + '</span>';
                w.wrong = (w.wrong || 0) + 1;
                wrong.push(w);
                
                // Add to mistakes
                if (!mistakes.some(m => m.id === w.id)) {
                    mistakes.push(w);
                }
            }
            
            w.lastPracticed = new Date().toISOString();
            currentIndex++;
            
            saveUserData();
            updateUI();
            
            setTimeout(showNextWord, 1000);
        }

        function skipWord() {
            if (currentIndex < currentSession.length) {
                currentIndex++;
                showNextWord();
            }
        }

        function endPractice() {
            let duration = Math.round((Date.now() - startTime) / 1000);
            let score = Math.round((correct / currentSession.length) * 100);
            
            history.unshift({
                date: new Date().toISOString(),
                correct, total: currentSession.length, score, duration
            });
            
            if (correct === currentSession.length && currentSession.length > 0) {
                coins += 2;
                xp += 50;
                showNotification('üéâ Perfect! +2 coins, +50 XP', 'success');
                addActivity('üéØ', 'Perfect score in practice!');
                confetti({ particleCount: 100 });
            } else {
                addActivity('üìä', `Scored ${score}% in practice`);
            }
            
            saveUserData();
            updateUI();
            closePage('practicePage');
            showNotification('Practice complete! Score: ' + score + '%', 'success');
        }

        // ========== VOICE ==========
        function initVoice() {
            if (!window.speechSynthesis) {
                showNotification('Voice not supported', 'error');
                return;
            }
            loadVoices();
            if (speechSynthesis.onvoiceschanged) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            
            // Unlock voice on first click
            document.addEventListener('click', function unlock() {
                if (!window.speechSynthesis) return;
                let u = new SpeechSynthesisUtterance('');
                speechSynthesis.speak(u);
                speechSynthesis.cancel();
                document.removeEventListener('click', unlock);
            }, { once: true });
        }

        function loadVoices() {
            voices = synth.getVoices();
            let english = voices.filter(v => v.lang.includes('en'));
            if (english.length) {
                currentVoice = english.find(v => v.name.includes('Google')) || english[0];
            }
        }

        function speakText(text, rate = voiceSpeed) {
            if (!window.speechSynthesis) return;
            try {
                synth.cancel();
                let utterance = new SpeechSynthesisUtterance(text);
                if (currentVoice) utterance.voice = currentVoice;
                utterance.rate = rate;
                utterance.pitch = 1;
                utterance.volume = 1;
                utterance.lang = 'en-US';
                synth.speak(utterance);
            } catch (e) {
                console.log('Speech error:', e);
            }
        }

        function speakWord() {
            if (currentSession.length && currentIndex < currentSession.length) {
                speakText(currentSession[currentIndex].word);
            }
        }

        function repeatWord() {
            if (currentSession.length && currentIndex < currentSession.length) {
                let w = currentSession[currentIndex].word;
                speakText(w);
                setTimeout(() => speakText(w), 1000);
                setTimeout(() => speakText(w), 2000);
                showNotification('Repeating 3 times', 'info');
            }
        }

        function slowWord() {
            let oldSpeed = voiceSpeed;
            voiceSpeed = 0.5;
            speakWord();
            setTimeout(() => { voiceSpeed = oldSpeed; }, 3000);
            showNotification('Slow mode for 3 seconds', 'info');
        }

        function adjustSpeed(speed) {
            voiceSpeed = parseFloat(speed);
            document.getElementById('voiceSpeedDisplay').innerText = voiceSpeed.toFixed(1) + 'x';
        }

        function setAccent(accent) {
            document.querySelectorAll('.accent-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            // Change voice based on accent
            let lang = 'en-US';
            if (accent === 'uk') lang = 'en-GB';
            if (accent === 'au') lang = 'en-AU';
            
            let newVoice = voices.find(v => v.lang === lang);
            if (newVoice) currentVoice = newVoice;
        }

        function setLabAccent(accent) {
            setAccent(accent);
        }

        function spellWord(word) {
            if (!word) return;
            
            speakText(`Spelling: ${word}`, spellingSpeed * 0.8);
            
            let letters = word.split('');
            letters.forEach((l, i) => {
                setTimeout(() => speakText(l, spellingSpeed), 1000 + i * 400);
            });
            
            setTimeout(() => speakText(word, spellingSpeed * 0.9), 1000 + letters.length * 400 + 500);
        }

        function spellCurrentWord() {
            if (currentSession.length && currentIndex < currentSession.length) {
                spellWord(currentSession[currentIndex].word);
            }
        }

        // Voice Lab functions
        function speakLabWord() {
            let word = document.getElementById('voiceLabWord').innerText;
            speakText(word);
            updatePronunciationScore(75);
        }

        function startRecording() {
            showNotification('Recording started...', 'info');
            setTimeout(() => {
                showNotification('Recording finished', 'success');
                updatePronunciationScore(85);
            }, 3000);
        }

        function playRecording() {
            showNotification('Playing recording...', 'info');
        }

        function comparePronunciation() {
            showNotification('Comparing pronunciation...', 'info');
            updatePronunciationScore(82);
        }

        function updatePronunciationScore(score) {
            document.getElementById('labPronunciationScore').style.width = score + '%';
        }

        function changeLabWord() {
            let select = document.getElementById('labWordSelector');
            let word = select.options[select.selectedIndex].text;
            document.getElementById('voiceLabWord').innerText = word;
            
            // Update phonetic
            let phonetics = {
                'Hello': '/h…ôÀàl…ô ä/',
                'World': '/w…úÀêld/',
                'Analyze': '/Àà√¶n.…ôl.a…™z/',
                'Significant': '/s…™…°Ààn…™f.…™.k…ônt/'
            };
            document.getElementById('phonetic').innerText = phonetics[word] || '/w…úÀêd/';
        }

        // ========== SPELLING ==========
        function updateSpellingSpeed(speed) {
            spellingSpeed = parseFloat(speed);
            document.getElementById('spellingSpeedDisplay').innerText = spellingSpeed.toFixed(1) + 'x';
        }

        function setSpellingSpeed(speed) {
            spellingSpeed = speed;
            document.getElementById('spellingSpeedSlider').value = speed;
            document.getElementById('spellingSpeedDisplay').innerText = speed.toFixed(1) + 'x';
        }

        function startSpellingPractice() {
            if (!vocabulary.length) {
                showNotification('Add words first!', 'error');
                closePage('spellingPage');
                return;
            }
            
            let practiceWords = vocabulary.sort(() => 0.5 - Math.random()).slice(0, 5);
            window.spellingSession = { words: practiceWords, index: 0, correct: 0, total: practiceWords.length };
            showSpellingWord();
        }

        function showSpellingWord() {
            let s = window.spellingSession;
            if (!s || s.index >= s.words.length) {
                endSpellingPractice();
                return;
            }
            
            let w = s.words[s.index];
            document.getElementById('spellingArea').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size:48px; font-weight:bold; color:var(--primary); margin-bottom:20px;">${w.word}</div>
                    
                    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                        <button class="voice-btn" onclick="speakText('${w.word}')"><i class="fas fa-volume-up"></i></button>
                        <button class="voice-btn" onclick="spellWord('${w.word}')"><i class="fas fa-font"></i></button>
                    </div>
                    
                    <input type="text" id="spellingInput" placeholder="Type the word..." 
                           style="width:100%; padding:15px; font-size:18px; text-align:center; margin-bottom:20px;">
                    
                    <div style="display:flex; gap:10px;">
                        <button class="btn" style="flex:2;" onclick="checkSpelling()">Check</button>
                        <button class="btn btn-secondary" style="flex:1;" onclick="nextSpellingWord()">Skip</button>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <div>${s.index+1}/${s.total}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${(s.index/s.total)*100}%"></div></div>
                    </div>
                </div>
            `;
            setTimeout(() => document.getElementById('spellingInput').focus(), 300);
        }

        function checkSpelling() {
            let s = window.spellingSession;
            let w = s.words[s.index];
            let ans = document.getElementById('spellingInput').value.trim().toLowerCase();
            
            if (ans === w.word.toLowerCase()) {
                s.correct++;
                w.correct = (w.correct || 0) + 1;
                coins += 0.5;
                xp += 10;
                showNotification('‚úÖ Correct! +0.5 coins', 'success');
                addActivity('üî§', `Spelled "${w.word}" correctly`);
                confetti({ particleCount: 20 });
            } else {
                w.wrong = (w.wrong || 0) + 1;
                showNotification('‚ùå Wrong! Correct: ' + w.word, 'error');
                setTimeout(() => spellWord(w.word), 500);
            }
            
            saveUserData();
            updateUI();
            s.index++;
            setTimeout(() => showSpellingWord(), 1500);
        }

        function nextSpellingWord() {
            let s = window.spellingSession;
            if (!s) return;
            s.index++;
            showSpellingWord();
        }

        function endSpellingPractice() {
            let s = window.spellingSession;
            let score = Math.round((s.correct / s.total) * 100);
            
            if (s.correct === s.total) {
                coins += 2;
                xp += 30;
                showNotification('üéâ Perfect spelling! +2 coins', 'success');
                addActivity('üèÜ', 'Perfect spelling score!');
                confetti({ particleCount: 100 });
            }
            
            document.getElementById('spellingArea').innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <h2>Spelling Complete!</h2>
                    <div style="font-size:48px; color:var(--primary); margin:20px;">${s.correct}/${s.total}</div>
                    <div style="font-size:24px; margin-bottom:20px;">${score}%</div>
                    <button class="btn" onclick="startSpellingPractice()">Practice Again</button>
                </div>
            `;
            
            saveUserData();
            updateUI();
        }

        // ========== GAMES ==========
        let gameScore = 0;
        let gameTimer = null;

        function startGame(type) {
            document.getElementById('gameArea').style.display = 'block';
            gameScore = 0;
            document.getElementById('gameScore').innerText = '0';
            
            if (type === 'match' && vocabulary.length >= 4) {
                let words = vocabulary.sort(() => 0.5 - Math.random()).slice(0, 4);
                let currentWord = words[Math.floor(Math.random() * words.length)];
                document.getElementById('gameWord').innerText = currentWord.word;
                
                let options = words.map(w => w.meaning);
                document.getElementById('gameOptions').innerHTML = options.map(o => 
                    `<div class="game-option" onclick="checkGameAnswer('${o}', '${currentWord.meaning}')">${o}</div>`
                ).join('');
                
                startGameTimer(30);
            } else {
                showNotification('Need at least 4 words to play!', 'warning');
            }
        }

        function checkGameAnswer(selected, correct) {
            if (selected === correct) {
                gameScore += 10;
                document.getElementById('gameScore').innerText = gameScore;
                showNotification('‚úÖ Correct! +10 points', 'success');
            } else {
                showNotification('‚ùå Wrong!', 'error');
            }
        }

        function startGameTimer(seconds) {
            if (gameTimer) clearInterval(gameTimer);
            let timeLeft = seconds;
            gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('gameTimer').style.width = (timeLeft/seconds)*100 + '%';
                if (timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            if (gameTimer) clearInterval(gameTimer);
            coins += gameScore;
            saveUserData();
            updateUI();
            showNotification('Game over! +' + gameScore + ' coins', 'success');
            addActivity('üéÆ', `Earned ${gameScore} coins from games`);
            document.getElementById('gameArea').style.display = 'none';
        }

        // ========== CHAT ==========
        function initChat() {
            if (Object.keys(chatGroups).length === 0) {
                chatGroups = {
                    general: { 
                        id: 'general', 
                        name: 'General Chat', 
                        icon: 'üí¨', 
                        members: [], 
                        createdBy: 'system',
                        createdAt: new Date().toISOString()
                    },
                    ielts: { 
                        id: 'ielts', 
                        name: 'IELTS Discussion', 
                        icon: 'üìö', 
                        members: [], 
                        createdBy: 'system',
                        createdAt: new Date().toISOString()
                    }
                };
                saveChatGroups();
            }
            
            Object.keys(chatGroups).forEach(id => {
                if (!chatMessages[id]) chatMessages[id] = [];
            });
            saveChatMessages();
        }

        function saveChatGroups() {
            localStorage.setItem('chat_groups', JSON.stringify(chatGroups));
        }

        function saveChatMessages() {
            localStorage.setItem('chat_messages', JSON.stringify(chatMessages));
        }

        function renderGroups() {
            let container = document.getElementById('groupsList');
            if (!container) return;
            
            let myGroups = Object.values(chatGroups).filter(g => g.members?.includes(currentUser));
            
            if (myGroups.length === 0) {
                container.innerHTML = '<div style="padding:10px;">No groups yet</div>';
                return;
            }
            
            container.innerHTML = myGroups.map(g => `
                <span class="group-chip ${currentGroup === g.id ? 'active' : ''}" onclick="selectGroup('${g.id}')">
                    ${g.icon} ${g.name}
                </span>
            `).join('');
        }

        function selectGroup(groupId) {
            currentGroup = groupId;
            let g = chatGroups[groupId];
            
            document.getElementById('currentGroupName').innerText = g.name;
            document.getElementById('groupActions').style.display = 'flex';
            document.getElementById('messageInput').style.display = 'block';
            document.getElementById('memberCount').innerText = (g.members?.length || 0) + ' members';
            
            loadMessages(groupId);
            
            if (chatTimer) clearInterval(chatTimer);
            chatTimer = setInterval(() => loadMessages(groupId, false), 3000);
            
            renderGroups();
        }

        function loadMessages(groupId, scroll = true) {
            let container = document.getElementById('chatMessages');
            if (!container) return;
            
            let msgs = chatMessages[groupId] || [];
            
            if (msgs.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px;">No messages yet</div>';
                return;
            }
            
            let recent = msgs.slice(-30).reverse();
            
            container.innerHTML = recent.map(m => {
                let isOwn = m.sender === currentUser;
                return `
                    <div class="message-row ${isOwn ? 'own' : 'other'}">
                        ${!isOwn ? `<div class="message-avatar">${m.avatar || 'üë§'}</div>` : ''}
                        <div class="message-container">
                            ${!isOwn ? `<div class="message-sender">${m.senderName}</div>` : ''}
                            <div class="message-bubble ${isOwn ? 'own' : 'other'}">
                                ${m.text}
                                <div class="message-time">${formatTime(m.timestamp)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (scroll) container.scrollTop = container.scrollHeight;
        }

        function formatTime(timestamp) {
            let date = new Date(timestamp);
            let now = new Date();
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function sendMessage() {
            let input = document.getElementById('messageText');
            let text = input.value.trim();
            if (!text || !currentGroup) return;
            
            let user = users[currentUser];
            if (!user) return;
            
            let msg = {
                id: 'msg_' + Date.now(),
                sender: currentUser,
                senderName: user.username,
                avatar: user.avatar || 'üë§',
                text: text,
                timestamp: new Date().toISOString()
            };
            
            if (!chatMessages[currentGroup]) chatMessages[currentGroup] = [];
            chatMessages[currentGroup].push(msg);
            
            if (chatMessages[currentGroup].length > 100) chatMessages[currentGroup].shift();
            
            saveChatMessages();
            input.value = '';
            loadMessages(currentGroup);
            
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function createGroup() {
            let name = prompt('Enter group name:');
            if (!name) return;
            
            let icon = prompt('Enter emoji (default üí¨):') || 'üí¨';
            let id = 'group_' + Date.now();
            
            chatGroups[id] = {
                id, name, icon,
                members: [currentUser],
                createdBy: currentUser,
                createdAt: new Date().toISOString()
            };
            
            chatMessages[id] = [];
            
            saveChatGroups();
            saveChatMessages();
            renderGroups();
            selectGroup(id);
            showNotification('Group created!', 'success');
            addActivity('üí¨', `Created group "${name}"`);
        }

        function joinGroup() {
            let available = Object.values(chatGroups).filter(g => !g.members?.includes(currentUser));
            
            if (available.length === 0) {
                showNotification('No groups to join', 'info');
                return;
            }
            
            let list = available.map((g, i) => `${i+1}. ${g.icon} ${g.name}`).join('\n');
            let choice = prompt('Available groups:\n' + list + '\n\nEnter number:');
            
            if (!choice) return;
            
            let idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < available.length) {
                let g = available[idx];
                if (!g.members) g.members = [];
                g.members.push(currentUser);
                saveChatGroups();
                renderGroups();
                selectGroup(g.id);
                showNotification('Joined ' + g.name, 'success');
                addActivity('üëã', `Joined group "${g.name}"`);
            }
        }

        function leaveGroup() {
            if (!confirm('Leave this group?')) return;
            
            let g = chatGroups[currentGroup];
            g.members = (g.members || []).filter(id => id !== currentUser);
            
            saveChatGroups();
            
            currentGroup = null;
            document.getElementById('currentGroupName').innerText = 'Select Group';
            document.getElementById('groupActions').style.display = 'none';
            document.getElementById('messageInput').style.display = 'none';
            document.getElementById('chatMessages').innerHTML = '<div style="text-align:center; padding:30px;">Select a group</div>';
            
            renderGroups();
            showNotification('Left group', 'info');
        }

        function showMembers() {
            let g = chatGroups[currentGroup];
            if (!g) return;
            
            let members = (g.members || []).map(id => users[id]).filter(u => u);
            
            document.getElementById('membersList').innerHTML = members.map(u => `
                <div style="display:flex; align-items:center; gap:10px; padding:10px; background:var(--bg); border-radius:12px; margin-bottom:5px;">
                    <div style="width:35px; height:35px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center;">
                        ${u.avatar || 'üë§'}
                    </div>
                    <div>
                        <div><strong>${u.name}</strong> ${g.createdBy === u.id ? 'üëë' : ''}</div>
                        <div style="font-size:11px; color:var(--text-dim);">@${u.username}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('membersSidebar').style.display = 'flex';
        }

        function hideMembers() {
            document.getElementById('membersSidebar').style.display = 'none';
        }

        function showGroupInfo() {
            let g = chatGroups[currentGroup];
            if (!g) return;
            
            document.getElementById('groupInfoContent').innerHTML = `
                <div style="padding:15px;">
                    <div style="font-size:48px; text-align:center; margin-bottom:15px;">${g.icon}</div>
                    <p><strong>Name:</strong> ${g.name}</p>
                    <p><strong>ID:</strong> ${g.id}</p>
                    <p><strong>Created:</strong> ${new Date(g.createdAt).toLocaleDateString()}</p>
                    <p><strong>Members:</strong> ${g.members?.length || 0}</p>
                </div>
            `;
            document.getElementById('groupInfoSidebar').style.display = 'flex';
        }

        function hideGroupInfo() {
            document.getElementById('groupInfoSidebar').style.display = 'none';
        }

        // ========== STORE ==========
        function buyItem(item) {
            if (coins !== Infinity && coins < 50) {
                showNotification('Not enough coins', 'error');
                return;
            }
            
            if (coins !== Infinity) {
                if (item === 'xp') coins -= 50;
                if (item === 'pack') coins -= 80;
                if (item === 'theme') coins -= 200;
                if (item === 'freeze') coins -= 30;
            }
            
            if (item === 'xp') {
                showNotification('‚ö° XP Boost activated for 1 hour!', 'success');
                addActivity('‚ö°', 'Activated XP Boost');
            } else if (item === 'pack') {
                for (let i = 0; i < 20; i++) {
                    vocabulary.push({
                        id: Date.now() + i,
                        word: 'word' + i,
                        meaning: 'meaning' + i,
                        category: 'general',
                        correct: 0, wrong: 0
                    });
                }
                showNotification('üìö 20 random words added!', 'success');
                addActivity('üìö', 'Bought Word Pack');
            } else if (item === 'theme') {
                showNotification('üé® All themes unlocked!', 'success');
            } else if (item === 'freeze') {
                showNotification('‚ùÑÔ∏è Streak freeze activated!', 'success');
            }
            
            saveUserData();
            updateUI();
            document.getElementById('storeCoins').innerText = coins === Infinity ? '‚àû' : coins;
        }

        // ========== RANKING ==========
        function switchRankingTab(tab) {
            document.querySelectorAll('.ranking-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderRanking(tab);
        }

        function renderRanking(tab = 'global') {
            let list = Object.values(users)
                .map(u => ({ name: u.username, xp: u.xp || 0, level: u.level || 1 }))
                .sort((a, b) => b.xp - a.xp)
                .slice(0, 20);
            
            document.getElementById('rankingList').innerHTML = list.map((u, i) => `
                <div style="display:flex; align-items:center; gap:15px; padding:15px; background:var(--bg); border-radius:12px; margin-bottom:5px;">
                    <div style="width:40px; font-weight:bold; font-size:18px; color:${i < 3 ? 'gold' : 'var(--text)'};">#${i+1}</div>
                    <div style="width:40px; height:40px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center;">
                        üë§
                    </div>
                    <div style="flex:1;">
                        <div><strong>${u.name}</strong></div>
                        <div style="font-size:11px; color:var(--text-dim);">Level ${u.level}</div>
                    </div>
                    <div style="font-weight:bold; color:gold;">${u.xp} XP</div>
                </div>
            `).join('');
        }

        // ========== STATISTICS ==========
        function renderStats() {
            document.getElementById('statTotalWords').innerText = vocabulary.length;
            
            let totalCorrect = vocabulary.reduce((s, w) => s + (w.correct || 0), 0);
            let totalAttempts = vocabulary.reduce((s, w) => s + (w.correct || 0) + (w.wrong || 0), 0);
            let mastery = totalAttempts ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            document.getElementById('statMastery').innerText = mastery + '%';
            document.getElementById('statStreak').innerText = streak;
            document.getElementById('statLevel').innerText = level;
            
            // Progress Chart
            let ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Words Learned',
                        data: [5, 12, 18, vocabulary.length],
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Category Chart
            let categories = {};
            vocabulary.forEach(w => {
                categories[w.category] = (categories[w.category] || 0) + 1;
            });
            
            let ctx2 = document.getElementById('categoryChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: ['#e67e22', '#3498db', '#2ecc71', '#f39c12', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Heatmap
            let heatmap = document.getElementById('heatmap');
            heatmap.innerHTML = '';
            for (let i = 0; i < 53 * 7; i++) {
                let cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                let level = Math.floor(Math.random() * 5);
                cell.setAttribute('data-level', level);
                heatmap.appendChild(cell);
            }
            
            // Weak words
            let weak = mistakes.slice(0, 6);
            let weakContainer = document.getElementById('weakWords');
            if (weak.length === 0) {
                weakContainer.innerHTML = '<div style="padding:20px; text-align:center;">No weak words! üéâ</div>';
            } else {
                weakContainer.innerHTML = weak.map(w => `
                    <div class="weak-word-card">
                        <div class="weak-word">${w.word}</div>
                        <div class="weak-meaning">${w.meaning}</div>
                        <div class="weak-stats">
                            <span>‚ùå ${w.wrong || 0} mistakes</span>
                            <span>‚úì ${w.correct || 0} correct</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ========== ACHIEVEMENTS ==========
        const ACHIEVEMENTS = [
            { id: 'first', name: 'First Word', icon: 'üìù', desc: 'Add your first word', reward: 10 },
            { id: 'ten', name: 'Collector', icon: 'üìö', desc: 'Add 10 words', reward: 20 },
            { id: 'perfect', name: 'Perfect Practice', icon: 'üéØ', desc: 'Get 10/10 in practice', reward: 30 },
            { id: 'streak7', name: 'Weekly Warrior', icon: 'üî•', desc: '7 day streak', reward: 50 },
            { id: 'chatty', name: 'Social Butterfly', icon: 'üí¨', desc: 'Send 50 messages', reward: 40 },
            { id: 'gamer', name: 'Game Master', icon: 'üéÆ', desc: 'Earn 500 coins from games', reward: 100 }
        ];

        function renderAchievements() {
            let container = document.getElementById('achievementsContainer');
            let user = users[currentUser] || {};
            let unlocked = user.achievements || [];
            
            container.innerHTML = ACHIEVEMENTS.map(a => {
                let isUnlocked = unlocked.includes(a.id);
                return `
                    <div class="store-item" style="opacity: ${isUnlocked ? 1 : 0.5};">
                        <div class="item-icon">${a.icon}</div>
                        <div class="item-name">${a.name}</div>
                        <div class="item-desc">${a.desc}</div>
                        <div class="item-price">${a.reward} ü™ô</div>
                        ${isUnlocked ? '<span style="color:var(--success);">‚úì Unlocked</span>' : '<span style="color:var(--text-dim);">üîí Locked</span>'}
                    </div>
                `;
            }).join('');
        }

        function checkAchievements() {
            if (!currentUser) return;
            let user = users[currentUser];
            if (!user.achievements) user.achievements = [];
            
            let newUnlocks = [];
            
            if (vocabulary.length >= 1 && !user.achievements.includes('first')) {
                user.achievements.push('first');
                coins += 10;
                newUnlocks.push('First Word');
            }
            if (vocabulary.length >= 10 && !user.achievements.includes('ten')) {
                user.achievements.push('ten');
                coins += 20;
                newUnlocks.push('Collector');
            }
            
            if (newUnlocks.length > 0) {
                saveUserData();
                updateUI();
                newUnlocks.forEach(a => {
                    showNotification('üèÜ Achievement: ' + a + '!', 'success');
                    addActivity('üèÜ', 'Earned achievement: ' + a);
                    confetti({ particleCount: 50 });
                });
            }
        }

        // ========== THEME ==========
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('vt_theme', theme);
            
            // Update active state on theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(theme)) {
                    btn.classList.add('active');
                }
            });
        }

        // ========== PAGE MANAGEMENT ==========
        function openPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if (pageId === 'wordsPage') renderWords();
            if (pageId === 'ieltsPage') updateIELTSProgress();
            if (pageId === 'statsPage') renderStats();
            if (pageId === 'achievementsPage') renderAchievements();
            if (pageId === 'rankingPage') renderRanking();
            if (pageId === 'chatPage') renderGroups();
            if (pageId === 'practicePage') startPractice();
            if (pageId === 'spellingPage') startSpellingPractice();
            if (pageId === 'storePage') document.getElementById('storeCoins').innerText = coins === Infinity ? '‚àû' : coins;
        }

        function closePage(pageId) {
            document.getElementById(pageId).classList.remove('active');
            if (pageId === 'chatPage' && chatTimer) clearInterval(chatTimer);
        }

        // Start everything
        init();

        // Expose functions to global scope
        window.switchAuthTab = switchAuthTab;
        window.checkPasswordStrength = checkPasswordStrength;
        window.registerUser = registerUser;
        window.verifyEmail = verifyEmail;
        window.resendCode = resendCode;
        window.closeVerificationModal = closeVerificationModal;
        window.showForgotPassword = showForgotPassword;
        window.sendResetLink = sendResetLink;
        window.loginUser = loginUser;
        window.logout = logout;
        window.setTheme = setTheme;
        window.openPage = openPage;
        window.closePage = closePage;
        window.addWord = addWord;
        window.deleteWord = deleteWord;
        window.debounceSearch = debounceSearch;
        window.applyFilters = applyFilters;
        window.toggleViewMode = toggleViewMode;
        window.exportVocabulary = exportVocabulary;
        window.loadIELTSPack = loadIELTSPack;
        window.showIELTSProgress = updateIELTSProgress;
        window.speakText = speakText;
        window.speakWord = speakWord;
        window.repeatWord = repeatWord;
        window.slowWord = slowWord;
        window.adjustSpeed = adjustSpeed;
        window.setAccent = setAccent;
        window.setLabAccent = setLabAccent;
        window.spellWord = spellWord;
        window.spellCurrentWord = spellCurrentWord;
        window.speakLabWord = speakLabWord;
        window.startRecording = startRecording;
        window.playRecording = playRecording;
        window.comparePronunciation = comparePronunciation;
        window.changeLabWord = changeLabWord;
        window.checkAnswer = checkAnswer;
        window.skipWord = skipWord;
        window.updateSpellingSpeed = updateSpellingSpeed;
        window.setSpellingSpeed = setSpellingSpeed;
        window.checkSpelling = checkSpelling;
        window.nextSpellingWord = nextSpellingWord;
        window.startGame = startGame;
        window.checkGameAnswer = checkGameAnswer;
        window.endGame = endGame;
        window.createGroup = createGroup;
        window.joinGroup = joinGroup;
        window.selectGroup = selectGroup;
        window.sendMessage = sendMessage;
        window.leaveGroup = leaveGroup;
        window.showMembers = showMembers;
        window.hideMembers = hideMembers;
        window.showGroupInfo = showGroupInfo;
        window.hideGroupInfo = hideGroupInfo;
        window.buyItem = buyItem;
        window.switchRankingTab = switchRankingTab;
        window.clearActivity = clearActivity;
        window.showStatsDetail = (type) => showNotification('Detailed stats coming soon!', 'info');
    </script>
</body>
</html>